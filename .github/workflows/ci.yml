name: CI
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  build-subalfred:
    name: Build subalfred
    runs-on: ubuntu-latest
    steps:
      - name: Fetch latest code
        uses: actions/checkout@v2
        with:
          repository: l2ust/subalfred
          ref: main
      - name: Install Rust nightly-2021-09-01 toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-2021-09-01
          default: true
      - name: Build
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release
      - name: Compress subalfred
        run: cp target/release/subalfred . && tar cf subalfred.tar.zst subalfred -I pzstd
      - name: Upload subalfred
        uses: actions/upload-artifact@v2
        with:
          name: subalfred
          path: subalfred.tar.zst

  check-rust-code:
    name: Check Rust code
    runs-on: ubuntu-latest
    steps:
      - name: Fetch latest code
        uses: actions/checkout@v2
      - name: Install Rust nightly-2021-09-01 toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-2021-09-01
          target: wasm32-unknown-unknown
          default: true
      - name: Run checker
        uses: actions-rs/cargo@v1
        with:
          command: check
          args: --locked

  build-node-and-internal-test:
    name: Build node and internal test
    runs-on: ubuntu-latest
    steps:
      - name: Fetch latest code
        uses: actions/checkout@v2
      - name: Install Rust nightly-2021-09-01 toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-2021-09-01
          target: wasm32-unknown-unknown
          default: true
      - name: Build
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --locked
      - name: Test
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --release --all --locked
        env:
          CARGO_INCREMENTAL: 0
      - name: Compress node
        run: cp target/release/darwinia . && tar cf node.tar.zst darwinia -I pzstd
      - name: Upload node
        uses: actions/upload-artifact@v2
        with:
          name: node
          path: node.tar.zst

  check-default-features:
    name: Check default features
    runs-on: ubuntu-latest
    needs: [build-subalfred]
    steps:
      - name: Fetch latest code
        uses: actions/checkout@v2
      - name: Download subalfred
        uses: actions/download-artifact@v2
        with:
          name: subalfred
      - name: Uncompress subalfred
        run: tar xf subalfred.tar.zst -I pzstd
      - name: Run checker
        run: ./subalfred ci default-features -p ../darwinia

  check-with-node:
    name: Check with node
    runs-on: ubuntu-latest
    needs: [build-subalfred, build-node-and-internal-test]
    steps:
      - name: Download subalfred
        uses: actions/download-artifact@v2
        with:
          name: subalfred
      - name: Download node
        uses: actions/download-artifact@v2
        with:
          name: node
      - name: Uncompress subalfred and node
        run: tar xf subalfred.tar.zst -I pzstd && tar xf node.tar.zst -I pzstd
      - id: check-darwinia-runtime-version
        name: Check Darwinia runtime version
        run: |
          OUTPUT=$(./subalfred ci runtime-version -c Darwinia -e ./darwinia)
          OUTPUT="${OUTPUT//'%'/'%25'}​"
          OUTPUT="${OUTPUT//$'\n'/'%0A'}"
          OUTPUT="${OUTPUT//$'\r'/'%0D'}"
          echo "::set-output name=check-darwinia-runtime-version::$OUTPUT"
      - id: check-darwinia-storage-prefix
        name: Check Darwinia storage prefix
        run: |
          OUTPUT=$(./subalfred ci storage-prefix -c Darwinia -e ./darwinia)
          OUTPUT="${OUTPUT//'%'/'%25'}​"
          OUTPUT="${OUTPUT//$'\n'/'%0A'}"
          OUTPUT="${OUTPUT//$'\r'/'%0D'}"
          echo "::set-output name=check-darwinia-storage-prefix::$OUTPUT"
      - id: check-crab-runtime-version
        name: Check Crab runtime version
        run: |
          OUTPUT=$(./subalfred ci runtime-version -c Crab -e ./darwinia)
          OUTPUT="${OUTPUT//'%'/'%25'}​"
          OUTPUT="${OUTPUT//$'\n'/'%0A'}"
          OUTPUT="${OUTPUT//$'\r'/'%0D'}"
          echo "::set-output name=check-crab-runtime-version::$OUTPUT"
      - id: check-crab-storage-prefix
        name: Check Crab storage prefix
        run: |
          OUTPUT=$(./subalfred ci storage-prefix -c Crab -e ./darwinia)
          OUTPUT="${OUTPUT//'%'/'%25'}​"
          OUTPUT="${OUTPUT//$'\n'/'%0A'}"
          OUTPUT="${OUTPUT//$'\r'/'%0D'}"
          echo "::set-output name=check-crab-storage-prefix::$OUTPUT"
      - if: github.ref != 'refs/heads/master'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          append: true
          message: |
            <details>
            <summary>Commit ${{ github.event.pull_request.head.sha }}</summary>

            * Darwinia
              Check Runtime Version
              ```diff
              ${{ steps.check-darwinia-runtime-version.outputs.check-darwinia-runtime-version }}
              ```
              Check Storage Prefix
              ```diff
              ${{ steps.check-darwinia-storage-prefix.outputs.check-darwinia-storage-prefix }}
              ```
            * Crab
              Check Runtime Version
              ```diff
              ${{ steps.check-crab-runtime-version.outputs.check-crab-runtime-version }}
              ```
              Check Storage Prefix
              ```diff
              ${{ steps.check-crab-storage-prefix.outputs.check-crab-storage-prefix }}
              ```
            </details>

  clean-artifacts:
    name: Clean artifacts
    runs-on: ubuntu-latest
    if: always()
    needs: [check-default-features, check-with-node]
    steps:
      - uses: geekyeggo/delete-artifact@v1
        with:
          name: |
            subalfred
            node
